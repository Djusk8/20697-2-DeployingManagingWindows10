# Lab Answer Key:  Module 4: Managing user profiles and UE-V
# Lab A: Configuring user profiles and UE-V
  
## Exercise 1: Configuring roaming user profiles, Folder Redirection, and the primary computer setting
  
#### Task 1: Prepare the infrastructure
  
1. On  **LON-DC1**, on the taskbar, select  **File Explorer**. In the navigation pane, select  **Local Disk (C:)**.

2. In File Explorer, ** **in the details pane, right-click an empty space, point to  **New**, and then select  **Folder**. Type  **Profiles** as the folder name, and then press Enter.

3. Right-click the  **Profiles** folder, select **Share with**, ** **and then select  **Specific people**.

4. In the  **File Sharing** dialog box, in the text box, type **domain users**, select  **Add**, select the arrow near  **Read** for **Domain Users**, select  **Read/Write**, select  **Share** and then select **Done**.

5. In  **File Explorer**, in the details pane, right-click an empty space, point to  **New**, and then select  **Folder**. Type  **Redirected** as the folder name, and then press Enter.

6. Right-click the  **Redirected** folder, select **Share with** and then select **Specific people**.

7. In the  **File Sharing** dialog box, in the text box, type **domain users**, select  **Add**, select the arrow near  **Read** for **Domain Users**, select  **Read/Write**, select  **Share**, ** **select  **Done**, and then close File Explorer.



#### Task 2: Configure roaming user profiles
  
1. On  **LON-DC1**, on the taskbar, select  **Server Manager**. 

2. In  **Server Manager**, select  **Tools**, and then select  **Active Directory Users and Computers**.

3. In  **Active Directory Users and Computers**, in the navigation pane, expand  **Adatum.com**, and then select the  **Marketing** OU.

4. In the details pane, right-click  **Ada Russell**, and then select  **Properties**.

5. In the  **Ada Russell Properties** dialog box, on the **Profile** tab, in the **Profile path** text box, type **\\LON-DC1\Profiles\%username%**, and then select  **OK**.

6. Minimize the  **Active Directory Users and Computers** window.



#### Task 3: Configure Folder Redirection
  
1. On  **LON-DC1**, in  **Server Manager**, select  **Tools**, and then select  **Group Policy Management**.

2. In the  **Group Policy Management** console (GPMC), in the navigation pane, expand **Forest: Adatum.com**, expand  **Domains**, ** **and then expand  **Adatum.com**.

3. In the navigation pane, right-click the  **Marketing** OU, and then select **Create a GPO in this domain, and Link it here**. 

4. In the  **Name** text box, type **Folder Redirection**, and then select  **OK**.

5. In the GPMC, in the navigation pane, expand the  **Marketing** OU, right-click **Folder Redirection**, and then select  **Edit**. The  **Group Policy Management Editor** window opens.

6. In the  **Group Policy Management Editor** window, under **User Configuration** in the navigation pane, expand **Policies**, expand  **Windows Settings**, and then expand  **Folder Redirection**.

7. Right-click  **Documents**, ** **and then select  **Properties**.

8. In the  **Documents Properties** dialog box, in the **Setting** drop-down box, select **Basic – Redirect everyone’s folder to the same location**. 

9. In the  **Target folder location** section, in the **Root Path** text box, type **\\LON-DC1\Redirected**, ** **and then select  **OK**.

10. In the  **Warning** dialog box, select **Yes**. 

11. Close the  **Group Policy Management Editor** window, and then minimize the GPMC.



#### Task 4: Test roaming user profiles and Folder Redirection
  
1. On  **LON-DC1**, on the taskbar, select  **File Explorer**. ** **

2. In  **File Explorer**, in the navigation pane, select  **Local Disk (C:)**, ** **and then verify that the  **Profiles** and **Redirected** folders are empty.

3. Sign in to  **LON-CL1** as **Adatum\Ada** with the password **Pa55w.rd**.

4. Right-click anywhere on the desktop, point to  **New**, ** **and then select  **Folder**. Type  **Presentations** as the folder name, and then press Enter.

5. On the desktop, right-click anywhere, point to  **New**, and then select  **Shortcut**. 

6. Click  **Browse**, ** **expand  **This PC**, select  **Local Disk (C:)**, select  **OK**, select  **Next**, and then select  **Finish**. A shortcut to local disk C ** **is added to the desktop.

7. On the taskbar, select  **Start**, type  **notepad**, and then press Enter. 

8. In  **Notepad**, type your name. On the  **File** menu, select **Save As**, select the  **Documents** folder in the navigation pane, enter your name in the **File Name** text box, select **Save**, and then close  **Notepad**.

9. On the taskbar, select  **File Explorer**, and then in the navigation pane, select  **Documents**. In the details pane, right-click the file with your name, and then select  **Properties**. Verify that the location of that file points to the network, to  **\\LON-DC1\Redirected\Ada\Documents**, and that it is not stored inside Ada Russell’s local profile. Also, verify that there is an  **Offline Files** tab in the **File Properties** dialog box, and then select **OK**.

10. In the  **20697-2C-LON-CL1** window, select **File**, ** **and then select  **Settings**.

11. In the  **Settings for 20697-2C-LON-CL1** window, in the navigation pane, select **Network Adapter**. In the details pane, in the  **Virtual switch** dropdown list, select **Not connected**, and then select  **OK**.

12. In  **File Explorer**, in the details pane, right-click an empty space, select  **New**, select  **Text document**, type  **File1** as the file name, and then press Enter.

13. Right-click  **File1**, and then select  **Properties**. In the  **File1 Properties** dialog box, on the **Offline Files** tab verify that **File1** is offline with unsynced changes, and then select **OK**.

14. Double-click the file with your name. The file opens in Notepad, even when you do not have network connectivity. Type today’s date, close  **Notepad**, and select  **Save**.

15. In the  **20697-2C-LON-CL1** window, select **File**, ** **and then select  **Settings**.

16. In the  **Settings for 20697-2C-LON-CL1** window, in the navigation pane, select **Network Adapter**. In the details pane, in the  **Virtual switch** dropdown list, select **Private Network**, and then select  **OK**.
>  **Note:** Wait a few seconds till the **File Explorer** status bar shows an **Online** status.
17. Right-click  **File1**, and then select  **Properties**. In the  **File1 Properties** dialog box, ** **on the  **Offline Files** tab, verify that **File1** is now online, and then select **OK**.

18. On the taskbar, right-click  **Start**, select  **Shut down or sign out**, ** **and then select  **Sign out**.

19. On  **LON-DC1**, in  **File Explorer**, verify that the  **C:\Profiles** and **C:\Redirected** folders are no longer empty. The **Profiles** folder contains the Ada Russell roaming user profile ( **Ada.V6**), while the  **Redirected** folder contains Ada Russell’s ** **redirected  **Documents** folder.

20. Sign in to  **LON-CL2** as **Adatum\Ada** with the password **Pa55w.rd**.

21. Verify that the  **Presentations** folder and the **Local Disk (C)** shortcut are on the desktop.

22. On the taskbar, select  **Start**, type  **notepad**, and then press Enter.

23. In  **Notepad**, on the  **File** menu, select ** Open**, verify that you can see both the files that you created on  **LON-CL1**, select the file with your name, and then select  **Open**. 
>  **Note:** The file includes your name and the date. You added the date and saved the file on **LON-CL1** when you did not have network connectivity.
24. On the taskbar, right-click  **Start**, select  **Shut down or sign out**, ** **and then select  **Sign out**.



#### Task 5: Configure the primary computer setting
  
1. On  **LON-DC1**, maximize the  **Active Directory Users and Computers** window. ** **To turn on  **Advanced Features** view, on the **View** menu, select **Advanced Features**.

2. In the  **Active Directory Users and Computers** navigation pane, select the **Computers** container, in the details pane, right-click the **LON-CL1** computer account, and then select **Properties**.

3. On the  **Attribute Editor** tab, in the **Attributes** section, double-click the **distinguishedName** attribute, press Ctrl+C to copy its value to the Clipboard, and then select **OK** twice.
>  **Note:** The **distinguishedName** attribute should appear similar to the following: **CN=LON-CL1,CN=Computers,DC=adatum,DC=com**.
4. In the navigation pane, select the  **Marketing** OU, and in the details pane, right-click **Ada Russell**, and then select  **Properties**.

5. On the  **Attribute Editor** tab, in the **Attributes** section, select the **msDS-PrimaryComputer** attribute, and then select **Edit**.

6. Right-click in the  **Value to add** box, select **Paste**, and then select  **Add**.

7. Right-click in the  **Value to add** box, and then select **Paste** again. Replace **LON-CL1** with **LON-CL2**, and then select  **Add**.

8. In the  **Multi-valued String Editor** dialog box, select **OK**.

9. In the  **Ada Russell Properties** dialog box, select **OK**.

10. Minimize the  **Active Directory Users and Computers** window.

11. Maximize the GPMC, right-click the  **Default Domain Policy** Group Policy, and then select **Edit**.

12. In the  **Group Policy Management Editor** window, navigate to **Computer Configuration\Policies\Administrative Templates\System\User Profiles**. Double-click the  **Download roaming profiles on primary computers only** policy setting, select **Enabled**, ** **and then select  **OK**.

13. In the  **Group Policy Management Editor** window, navigate to **User Configuration\Policies\Administrative Templates\System\Folder Redirection**. Double-click the  **Redirect folders on primary computers only** policy setting, select **Enabled**, ** **and then select  **OK**.

14. Close the  **Group Policy Management Editor** window and the GPMC.

15. On  **LON-CL4**, on the taskbar, select  **File Explorer**, right-click  **This PC**, and then select  **Properties**.

16. In the  **System** window, ** **select  **Change settings**.

17. In  **System Properties**, select  **Change**. Select the  **Domain** option, type **Adatum.com** in the **Domain** text box, and then select **OK**.

18. In the  **User name** text box, type **Administrator**, in the  **Password** text box, type **Pa55w.rd**, select  **OK** four times, select **Close**, and then select  **Restart Now**.



#### Task 6: Test the primary computer setting
  
1. Sign in to  **LON-CL4** as **Adatum\Ada** with the password **Pa55w.rd**.

2. Verify that the  **Presentations** folder and the **Local Disk (C)** shortcut are not on the desktop. This is because **LON-CL4** is not set as one of Ada Russell’s primary computers, and her roaming user profile is not available on **LON-CL4**.

3. On the taskbar, select  **Start**, type  **notepad**, and then press Enter. 

4. In  **Notepad**, on the  **File** menu, select ** Open**, and then in the navigation pane, select  **Documents**. ** **Verify that the folder is empty and the file with your name is not available. This is because  **LON-CL4** is not set as one of Ada Russell’s primary computers, and her redirected folders are not available on **LON-CL4**. Select  **Cancel**.

5. On the taskbar, right-click  **Start**, select  **Shut down or sign out**, ** **and then select  **Sign out**.

6. On  **LON-DC1**, maximize the  **Active Directory Users and Computers** window, ** select** the **Marketing** OU in the navigation pane, right-click **Ada Russell** in the details pane, and then select **Properties**.

7. On the  **Attribute Editor** tab, in the Attributes section, select the **msDS-PrimaryComputer** attribute, and then select **Edit**.

8. In the  **Multi-valued String Editor** dialog box, select the value that starts with **CN=LON-CL2**, and then select  **Remove**.

9. In the  **Value to add** box, replace **LON-CL2** with **LON-CL4**, select  **Add**, select  **OK** twice, and then minimize the **Active Directory Users and Computers** window.

10. Sign in to  **LON-CL4** as **Ada Russell** with the password **Pa55w.rd**.

11. Verify that the  **Presentations** folder and the **Local Disk (C)** shortcut are on the desktop. This is because you configured **LON-CL4** as Ada Russell’s primary computer and her roaming user profile is effective.

12. On the taskbar, select the  **File Explorer** icon.

13. In  **File Explorer**, in the navigation pane, select  **Document**s.
>  **Note:** The details pane is empty because the **Folder Redirection** GPO did not apply at first sign in. Sign out and sign in as **Ada Russell** with the password **Pa55w.rd**, ** **and then repeat steps 12 and 13.
14. In  **File Explorer**, in the details pane, double-click the file with your name. The file opens in  **Notepad**. Because you configured  **LON-CL4** as Ada Russell’s primary computer, redirected folders are available.

15. In  **Notepad**, on the  **File** menu, select ** Exit**.

16. In the  **20697-2C-LON-CL4** window, select **Action**, select  **Revert** twice, and then close the **20697-2C-LON-CL4** window.


>  **Result**: After completing this exercise, you should have configured roaming user profiles and Folder Redirection. You also should have configured a user with the primary computer setting.


## Exercise 2: Implementing and using UE-V
  
#### Task 1: Prepare the environment for UE-V
  
1. On  **LON-DC1**, on the taskbar, select  **File Explorer**. 

2. In File Explorer, in the navigation pane, select  **Local Disk (C:)**.

3. In File Explorer, ** **in the details pane, right-click an empty space, point to  **New**, and then select  **Folder**. Type  **UEVData** as the folder name, and then press Enter.

4. In  **File Explorer**, right-click  **UEVData**, select  **Share with**, ** **and then select  **Specific people**.

5. In the  **File Sharing** dialog box, in the text box, type **domain users**, select  **Add**, select the arrow near  **Read** for ** Domain Users**, select  **Read/Write**, select  **Share**, ** **and then select  **Done**.

6. In  **File Explorer**, in the details pane, right-click an empty space, point to  **New**, and then select ** Folder**. Type  **UEVTemplates** as the folder name, and then press Enter.

7. In  **File Explorer**, right-click the  **UEVTemplates**, select  **Share with**, ** **and then select  **Specific people**.

8. In the  **File Sharing** dialog box, in the text box type **domain users**, select  **Add**, select the arrow near  **Read** for ** Domain Users**, select  **Read/Write**, select  **Share**, ** **and then select  **Done**.

9. Minimize File Explorer.



#### Task 2: Configure UE-V Group Policy settings
  
1. On  **LON-DC1**, in  **Server Manager**, select  **Tools**, and then select  **Group Policy Management**.

2. In the GPMC, in the navigation pane, expand  **Forest: Adatum.com**, expand  **Domains**, ** **and then expand  **Adatum.com**.

3. In the navigation pane, right-click the  **Adatum.com**, and then select  **Create a GPO in this domain, and Link it here**. In the  **Name** text box type **UE-V**, and then select  **OK**.

4. In the GPMC, in the navigation pane, right-click the  **UE-V** Group Policy, and then select **Edit**.

5. In the  **Group Policy Management Editor** window, in the navigation pane, under **Computer Configuration**, expand  **Policies**, expand  **Administrative Templates**, expand  **Windows Components**, and then select the  **Microsoft User Experience Virtualization** node.

6. In the details pane, right-click  **Enable UEV**, select  **Edit**, select  **Enabled**, and then select  **OK**.

7. In the details pane, right-click  **Settings template catalog path**, select  **Edit**, select  **Enabled**, in the  **Settings template catalog path** text box, type **\\LON-DC1\UEVTemplates**, and then select  **OK**.

8. In the  **Group Policy Management Editor** window, in the navigation pane, under **User Configuration**, expand  **Policies**, expand  **Administrative Templates**, expand  **Windows Components**, and then select the  **Microsoft User Experience Virtualization** node.

9. In the details pane, right-click  **Settings storage path**, select  **Edit**, select  **Enabled**, in the  **Settings storage path** text box, type **\\LON-DC1\UEVData\%username%**, and then select  **OK**.

10. In the details pane, right-click  **Synchronize Windows settings**, select  **Edit**, select  **Enabled**, select the  **Roaming Credentials** check box, and then select **OK**. 
>  **Note:** All five check boxes are selected.
11. Close the  **Group Policy Management Editor** window and the GPMC.



#### Task 3: Enable UE-V, and then verify the effective settings
  
1. Sign in to  **LON-CL1** as **Adatum\Administrator** with the password **Pa55w.rd**.

2. On the taskbar, select  **Start**, type  **PowerShell**, and then press Enter.

3. In Windows PowerShell, type  **Get-UevStatus**, and then press Enter. The output shows that UE-V is currently not enabled.

4. In Windows PowerShell, type  **Enable-Uev** to enable UE-V, and then press Enter.
>  **Note:** You must restart the computer for this change to take effect.
5. In Windows PowerShell, type  **Get-UevTemplate**, and then press Enter. There is no output, because by default, no settings location template is registered.

6. In  **Windows PowerShell**, type  **Register-UevTemplate -Path C:\ProgramData\Microsoft\UEV\InboxTemplates\*.xml**, and then press Enter to register the default UE-V templates.

7. In  **Windows PowerShell**, type  **Get-UevTemplate**, and then press Enter. The output shows the default UE-V templates, which are now registered.

8. In  **Windows PowerShell**, type  **Restart-Computer**, ** **and then press Enter.

9. Sign in to  **LON-CL2** as **Adatum\Administrator** with the password **Pa55w.rd**.

10. On the taskbar, select  **Start**, type  **PowerShell**, and then press Enter.

11. In  **Windows PowerShell**, type  **C:\Labfiles\Mod04\ConfigureUEV.ps1**, ** **and then press Enter. This script performs the same configuration as you manually did on  **LON-CL1**.



#### Task 4: Configure UE-V SyncMethod
  
1. Sign in to  **LON-CL1** and ** LON-CL2** as **Adatum\Administrator** with the password **Pa55w.rd**.

2. On  **LON-CL1**, on the taskbar, select  **Start**, type  **PowerShell**, and then press Enter.

3. In  **Windows PowerShell**, type  **Get-UevConfiguration** to view the current UE-V configuration, and then press Enter. You will see that values for **SettingsStoragePath** and **SettingsTemplateCatalogPath** are configured as you set them in Group Policy.
>  **Note:** Notice that **SyncMethod** is set to **SyncProvider**. This means that UE-V is using the local setting cache, which is synced with the shared network folder every 30 minutes.
4. View all UE-V Windows PowerShell cmdlets by running the  **Get-Command –Module UEV** cmdlet.

5. In  **Windows PowerShell**, type  **notepad**, ** **and then press Enter.

6. In  **Notepad**, in the  **Format** menu, select **Font**. In the  **Font** window, select **Verdana** font, and in the **Size** box, select **48**, select  **OK**, type your name to verify that the selected font is used, close  **Notepad**, and then select  **Don’t Save**.

7. On  **LON-CL2**, on the taskbar, select  **Start**, type  **PowerShell**, and then press Enter.

8. In  **Windows PowerShell**, type  **notepad**, and then press Enter.

9. In  **Notepad**, type your name. You will notice that the default font is used and not the font that you selected on  **LON-CL1**. Close Notepad, and do not save changes.
>  **Note:** UE-V uses the local settings cache by default. This is the reason why changes from **LON-CL1** are not used on **LON-CL2** yet.
10. In Windows PowerShell, type  **Set-UevConfiguration–SyncMethod None** to configure UE-V to read settings directly from the network instead from the local settings cache, and then press Enter.

11. In Windows PowerShell, type  **notepad**, and then press Enter.

12. In Notepad, type your name. You will notice that the large Verdana font that you selected on  **LON-CL1** is being used. UE-V on **LON-CL2** is now reading settings from the network location.

13. In Notepad, select  **Format**, select  **Font**, select  **Arial** font, select Size **26**, select  **OK**, ** **and then close Notepad without saving changes.

14. On  **LON-CL1**, in Windows PowerShell, type  **Set-UevConfiguration–SyncMethodNone**, ** **and then press Enter.

15. In Windows PowerShell, type  **notepad**, ** **and then press Enter.

16. In Notepad, verify that  **Arial** font size **26** is used, as you selected on **LON-CL2**. This is because you configured UE-V on  **LON-CL1** to read the settings directly from the network.

17. Close Notepad, and do not save changes.

>  **Note:** You would typically configure **SyncMethod** by using Group Policy. In this lab, you configured it manually to see the difference between UE-V using local settings cache and reading settings directly from the shared network folder.


#### Task 5: Use UE-V synchronization
  
1. On  **LON-CL2**, on the taskbar, select  **Start**, ** **type  **wordpad**, and then press Enter.

2. In WordPad, select the  **View** tab, and then verify that the **Ruler** and **Status bar** check boxes are selected by default. Clear the **Ruler** and **Status bar** check boxes, and then close **WordPad**.

3. On the desktop, right-click anywhere, point to  **New**, and then select  **Shortcut**. Select  **Browse**, ** **expand  **This PC**, select  **Local Disk (C:)**, select  **OK**, select  **Next**, and then select  **Finish**. 
>  **Note:** A shortcut to **Local Disk (C)** is added to the desktop.
4. On the taskbar, select  **Start**, ** **type  **notepad**, and then press Enter. Type your name in Notepad. On the  **File** menu, select **Save As**, in the navigation pane select  **Documents**, type your name in the  **File Name** text box, select **Save** and then close Notepad.

5. On the taskbar, select  **Start**, ** **type  **certmgr.msc**, and then press Enter.

6. In the  **Certificates** console, in the navigation pane, right-click **Personal**, select  **All Tasks**, ** **and then select  **Request New Certificate**. 

7. In the  **Certificate Enrollment** wizard, select **Next** twice, select the **User** checkbox, select **Enroll**, ** **and then select  **Finish**.

8. In the  **Certificates** console, in the navigation pane, expand **Personal**, select  **Certificates**, in the details pane, verify that the  **Administrator** has a certificate, and then close the **Certificates** console.

9. On the taskbar, select  **Start**, ** **type  **control**, and then select  **Control Panel**

10. In  **Control Panel**, in the  **Search Control Panel** text box, type **printer**, ** **and then select  **Devices and Printers**.

11. In  **Devices and Printers**, select  **Add a printer** and then select **The printer that I want isn’t listed**. The  **Add Printer** wizard ** **opens.

12. On the  **Add Printer** page, select the **Select a shared printer by name** option, type **\\LON-DC1\Printer1** in the **Select a shared printer by name** text box, select **Next** twice, and then select **Finish**.

13. Verify that after a few seconds,  **Microsoft PS Class Driver on lon-dc1** is added, and then close the **Devices and Printers** window.

14. On  **LON-DC1**, in  **File Explorer**, verify that the  **C:\UEVdata** folder has a subfolder named **Administrator**.

15. In File Explorer, select the  **View** tab, select the **Hidden items** check box, double-click the **Administrator** folder, and then verify that it contains the **SettingsPackages** subfolder. Double-click the **SettingsPackages** folder, and then verify that it contains multiple subfolders for the applications and Windows settings that UE-V syncs.
>  **Note:** The **SettingsPackages** folder includes the **MicrosoftWordpad6** subfolder, because WordPad stores its settings as soon as you close the app.
16. On  **LON-CL1**, on the taskbar, select  **Start**, type  **wordpad**, and then press Enter.

17. On the  **View** tab, verify that the **Ruler** and **Status bar** check boxes are not selected, which is not the default configuration, but it is exactly as you configured it on **LON-CL2**. Close WordPad.

18. On  **LON-CL1**, in Windows PowerShell, type  **logoff**, ** **and then press Enter.

19. On  **LON-CL2**, in Windows PowerShell, type  **logoff**, ** **and then press Enter.

20. Sign in to  **LON-CL1** as **Adatum\Administrator** with the password **Pa55w.rd**.

21. On  **LON-CL1**, verify that a shortcut to  **Local Disk (C)** is not present on the desktop. You created it on the desktop on **LON-CL2**, and it is stored in the local user profile.
>  **Note:** UE-V does not sync desktop contents. Instead, you should use **Folder Redirection** or roaming user profiles to make data roam between computers.
22. On  **LON-CL1**, on the taskbar, select  **Start**, type  **notepad**, and then press Enter.

23. In  **Notepad**, on the  **File** menu, select **Open**. In the navigation pane, expand  **This PC**, and then select  **Documents**.

24. Verify that the file with your name is not available in the details pane. You created a file with your name on  **LON-CL2**, ** **and it is stored in the local user profile. Select  **Cancel**, and then close  **Notepad**.
>  **Note:** You should use **Folder Redirection** or roaming user profiles to make data roam between computers. UE-V syncs settings only, not data. The **Folder Redirection** GPO that you created earlier does not apply to the Administrator, because the Administrator is not in the **Marketing** OU.
25. On the taskbar, select  **Start**, type  **certmgr.msc**, and then press Enter.

26. In the  **Certificates** console, in the navigation pane, expand **Personal**, and then verify that no user certificate is present. UE-V sync certificates when a user signs out for the second time.

27. On the taskbar, right-click  **Start**, select  **Shut down or sign out**, ** **and then select  **Sign out**.

28. Sign in to  **LON-CL2** as **Adatum\Administrator** with the password **Pa55w.rd**, and then sign out immediately.

29. Sign in to  **LON-CL1** as **Adatum\Administrator** with the password **Pa55w.rd**.

30. On the taskbar, select  **Start**, type  **certmgr.msc**, and then press Enter.

31. In the  **Certificates** console, in the navigation pane, expand **Personal**, select  **Certificates**, in the details pane. verify that the  **Administrator** has the certificate and then close the **Certificates** console.

32. On the taskbar, select  **Start**, ** **type  **printer**, and then select  **Printers &amp; scanners**.

33. In the  **Settings** app, on the **Printers &amp; scanners** page, verify that **Microsoft PS Class Driver on lon-dc1** is listed. This network printer was synced by UE-V. Close the **Settings** app.



#### Task 6: Create and use custom UE-V template
  
1. On  **LON-CL1**, on the taskbar, select  **Start**, type  **generator**, ** **and then select  **Microsoft User Experience Virtualization (UE-V)**.

2. On the  **Microsoft User Experience Virtualization** page, select **Create a settings location template**.

3. On the  **Specify Application** page, select **Browse** for the **File path**, go to  **C:\Program Files (x86)\Microsoft\Remote Desktop Connection Manager**, select  **RDCMan.exe**, select  **Open**, and then select  **Next**.
>  **Note:** You will create a settings location template for **Remote Desktop Connection Manager**.
4. After a few seconds,  **Remote Desktop Connection Manager** opens. In **Remote Desktop Connection Manager**, select  **Tools**, ** **and then select  **Options**.

5. In the  **Options** dialog box, on the **Tree** tab, select the **Click to select gives focus to remote client** check box, and then select **OK**. ** **Close  **Remote Desktop Connection Manager**.

6. In the  **Discover Locations** dialog box, select **Next**.

7. On the  **Review Locations** page, select the **Files** tab, select **Nonstandard (2)**, ** **select the  **File path** checkbox for the location that includes **Remote Desktop Connection Manager**, and then select  **Next**.

8. On the  **Edit Template** page, view the settings location template properties. You could modify the registry and files that are used for storing configuration data on this page. Select **Create**, in the  **File name** text box, type **\\LON-DC1\UEVTemplates\RDCMan.xml**, ** **and then ** **select  **Save**.

9. In the  **Create a Settings Location Template Wizard**, on the  **Finish** page, select **Close**, and then close the  **Microsoft User Experience Virtualization** page.

10. On  **LON-CL1**, on the taskbar, select  **Start**, type  **powershell**, and then press Enter.

11. In the Windows PowerShell command prompt, type the following command, and then press Enter: 

  ```
  Get-UevTemplate *rdc*
  ```

>  **Note:** The output is empty, which shows that no settings location template that contains the string “rdc” is currently registered.
12. Register the Remote Desktop Connection Manager settings location template by typing the following cmdlet, and then press Enter:

  ```
  Register-UevTemplate \\LON-DC1\UEVTemplates\RDCMan.xml 
  ```

>  **Note:** By default, the settings location template updates register once per day. By running the cmdlet, you are manually registering the template.
13. To verify that the template is registered, type the following cmdlet, and then press Enter: 

  ```
  Get-UevTemplate *rdc* 
  ```

>  **Note:** You can see that the Remote Desktop Connection Manager template with **TemplateId Remote-Desktop-RDCMan-v-2-7** is listed.
14. Sign in to  **LON-CL2** as **Adatum\Administrator** with the password **Pa55w.rd**.

15. On  **LON-CL2**, on the taskbar, select  **Start**, type  **powershell**, and then press Enter.

16. Register the Remote Desktop Connection Manager settings location template by typing the following cmdlet, and the pressing Enter:

  ```
  Register-UevTemplate \\LON-DC1\UEVTemplates\RDCMan.xml 
  ```

17. On  **LON-CL1**, on the taskbar, select  **Start**, type  **remote**, and then select  **Remote Desktop Connection Manager**.

18. In Remote Desktop Connection Manager v2.7, select  **Tools**, ** **and then select  **Options**. ** **

19. In the  **Options** dialog box, ** **select the  **Auto save interval** check box, ** **and then in the  **minute(s)** text box, type **3**. Select  **OK**, ** **and then close Remote Desktop Connection Manager.

20. On  **LON-CL2**, on the taskbar, select  **Start**, type  **remote**, and then select  **Remote Desktop Connection Manager**.

21. In Remote Desktop Connection Manager v2.7, select  **Tools**, select  **Options**, ** **and then verify that ** Auto save interval** is selected and is configured to **3 minute(s)**. Select  **OK**, ** **and then close Remote Desktop Connection Manager.

22. To view the  **TemplateId** of the template, in Windows PowerShell, type the following cmdlet, and then press Enter:

  ```
  Get-UevTemplate *rdc* 
  ```

23. To revert Remote Desktop Connection Manager ** **to its initial values, in Windows PowerShell, type the following cmdlet, and then press Enter:

  ```
  Restore-UevUserSetting Remote-Desktop-RDCMan-v-2-7
  ```

24. On the taskbar, select  **Start**, type  **remote**, and then select  **Remote Desktop Connection Manager**.

25. In Remote Desktop Connection Manager v2.7, select  **Tools**, select  **Options**, ** **and then verify that ** Auto save interval** is not enabled, which was the initial state. Select **OK**, ** **and then close Remote Desktop Connection Manager v2.7.


>  **Result**: After completing this exercise, you should have successfully implemented and configured UE-V for syncing apps and Windows settings.


## Exercise 3: Configuring and using Enterprise State Roaming
  
#### Task 1: Enable Enterprise State Roaming
  
1. On  **LON-DC1**, on the taskbar, right-click  **Internet Explorer**, and then select  **Start InPrivate Browsing**.

2. In Internet Explorer, in the address bar, type  **https://portal.azure.com** and press Enter **.**

3. On the  **Microsoft Azure** page, enter the Microsoft account credentials that you created in lab in module 3, and then select **Sign in**.
>  **Note:** If you followed the suggestion in the lab in Module 3, you created a Microsoft account in the format **&lt;YourInitials&gt;MMDDYY@outlook.com** and used **Pa55w.rd!** as the password. For example, if your name is Don Funk and you created Microsoft account on November 18, 2017, your account should be DF111817@outlook.com.
4. In the Azure Portal, in the navigation pane, select  **Azure Active Directory**.

5. In the  **Azure Active Directory** blade, in the navigation pane, select **Devices**.

6. In the  **Devices** blade, make a note of devices that are listed in the details pane. In the navigation pane, select **Device settings**.

7. In the  **Devices – Device settings** blade, in the details pane, in the **Users may sync settings and app data across devices** section, select **Selected**.

8. Click  **No member selected**, select  **+ Add members**, type  **Aidan** in the text box, select **Aidan Norman**, select  **Add**, select  **OK**, ** **and then select  **Save**. Make note of Aidan’s account, because you will need it in the next task.

>  **Note:** By performing this task, you enabled Enterprise State Roaming for Aidan Norman.


#### Task 2: Add a computer to Azure AD
  
1. In Hyper-V manager, right-click  **20697-2C-LON-CL5**, select  **Start**, and then double-click  **20697-2C-LON-CL5**.

2. On  **LON-CL5**, on the  **Let’s start with region. Is this right?** page, select **Yes**.

3. On the  **Is this the right keyboard layout?** page, select **Yes**.

4. On the  **Want to add second keyboard layout?** page, select **Skip**.

5. On the  **Here’s the License Agreement** page, select **Accept**.

6. On the  **Sign in with Microsoft** page, in the text box, type **Aidan@&lt;YourInitialsDDMMYY&gt;outlook.onmicrosoft.com**, ** **and then select  **Next**.
>  **Note:** If you followed the suggestion in Module 3, you created a Microsoft account in the format **&lt;YourInitials&gt;MMDDYY@outlook.com**. For example, if your name is Don Funk and you created Microsoft account on November 18, 2017, your account should be DF111817@outlook.com. In that case, you should type  **Aidan@DF111817outlook.onmicrosoft.com** as the account.
7. On the  **Enter your password** page, type **Pa55w.rd**, ** **and then select  **Next**.

8. On the  **Choose privacy settings for your device** page, ** **select  **Accept**.

9. While the user is signing in to  **LON-CL5**, switch to  **LON-CL3**, and then sign in as the same user,  **Aidan@&lt;YourInitialsDDMMYY&gt;outlook.onmicrosoft.com**, and use  **Pa55w.rd** as the password.

10. On the  **Your organization requires Windows Hello** page, select **Set up PIN**, close the  **Help us protect your account** dialog box, ** **and then select  **Skip for now.**

11. On the taskbar, select  **Start**, type  **sync your**, ** **and then select  **Sync your settings**.

12. In the  **Settings** app, on the **Sync your settings** page, verify that **Sync Settings** is **On**. Also verify that all individual sync settings are turned on and that you are using device as Aidan@&lt;YourInitialsDDMMYY&gt;outlook.onmicrosoft.com. Close the  **Settings** app.

13. On  **LON-CL5**, on the  **Your organization requires Windows Hello** page, select **Set up PIN**, close the  **Help us protect your account** dialog box, ** **and then select  **Skip for now.**

14. On  **LON-CL5**, right-click on the desktop, select  **Personalize**, select one of the custom background pictures, and then close the  **Settings** app.



#### Task 3: View device properties and sync status
  
1. On  **LON-CL5**, on the taskbar, select  **Start**, type  **explorer**, ** **and select  **Internet Explorer**.

2. In  **Internet Explorer**, in the address bar, type  **www.microsoft.com/learning**, and then press Enter. When the page loads, right-click on the page, select  **Add to favorites**, ** **and then select  **Add**.

3. On  **LON-CL3**, on the taskbar, select  **Start**, type  **explorer**, ** **and then select  **Internet Explorer**.

4. In  **Internet Explorer**, select ALT+C to view favorites. Verify if  **Computer Training** favorites page is already synced from **LON-CL5**.
>  **Note:** Usually, Enterprise State Roaming syncs settings fairly quickly.
5. On  **LON-DC1**, in  **Internet Explorer**, on the  **Devices – Device settings** blade, in the navigation pane, select **All devices**.

6. In the details pane, view devices. Be aware that in this exercise, you added a device whose name starts with  **DESKTOP-** to Azure AD.

7. In the details pane, in the  **OWNER** column, select **Aidan Norman.**

8. In the  **Aidan Norman** blade, in the navigation pane, select **Devices**.

9. In the details pane, verify that in the  **Show** dropdown list, **Devices** is selected. This shows all the devices that Ana owns.

10. In the  **Show** drop-down list, select **Devices syncing settings and app data**. This view shows the devices that are synced by Enterprise State Roaming. It also shows when each device was last synced.



#### Task 4: Prepare for the next lab
  
1. On  **LON-DC1**, in Internet Explorer, on  **Devices – Device settings** blade, in the navigation pane, select **All devices**.

2. Click the name that starts with  **DESKTOP-**, select  **Delete**, and then select  **Yes.**

3. Close Internet Explorer.

4. In the  **GPMC**, delete the  **UE-V** Group Policy that is linked to the **Adatum.com** domain and **Folder Redirection** GPO that is linked to Marketing OU.

5. Create a checkpoint of  **LON-CL5**, and name it  **After Lab 4A**. You can create checkpoint by performing following steps:
In the 20697-2A-LON-CL5 window, select  **Action**, ** **and then select  **Checkpoint**.

In  **Checkpoint name** dialog box, type **After Lab 4A**, select  **Yes**, ** **and then select  **OK**. 

6. Revert the  **LON-CL1**,  **LON-CL2**, and  **LON-CL5** virtual machines. _Do not revert LON-DC1!_ You can revert virtual machines by performing following steps:
On the host computer, start Hyper-V Manager.

In the  **Virtual Machines** list, right-click **20697-2C-LON-CL1**, and then select  **Revert**.

In the  **Revert Virtual Machine** dialog box, select **Revert**.

Repeat steps b and c for  **20697-2C-LON-CL2** and **20697-2C-LON-CL5**.

7. Shut down LON-CL3. Do not revert LON-CL3.

8. Shut down  **MT17B-WS2016-NAT**.

>  **Note:** Do not revert **LON-DC1**.  **LON-DC1** is synchronizing on-premises AD DS with Azure AD.

>  **Result**: After completing this exercise, you should have successfully configured Enterprise State Roaming in Azure AD, joined a Windows 10 device to Azure AD, and performed a sync.



# Lab B: Migrating a user state by using USMT
  
## Exercise 1: Capture the user state on the source computer
  
#### Task 1: Create a custom XML migration file
  
1. Sign in to  **LON-CL2** as **Adatum\Vera** with the password **Pa55w.rd**.

2. Verify that Vera has a black desktop and following custom configuration:


  -  **This PC** and **Vera Pace** folders are on the desktop

  - Calculator and Weather apps are pinned to the taskbar

  - Store and Mail apps are not pinned to the taskbar


3. On the desktop, right-click anywhere, select  **New**, select  **Text Document**, type  _your name,_ and then press Enter.

4. On the taskbar, select  **File Explorer**. In File Explorer, in the navigation pane, expand  **This PC**, expand  **Local Disk (C:)**, expand  **Users**, expand  **Public**, ** **and then select  **Public Documents**. In the details pane, right-click anywhere, select  **New**, select  **Text Document**, type  **Vera’s Public Documents**, and then press Enter.

5. In the navigation pane, select  **Public Music**, in the details pane, right-click anywhere, select  **New**, select  **Text Document**, type  **Vera’s Public Music** and then press Enter.

6. Sign out of  **LON-CL2**, ** **and then sign in to LON-CL2 as  **Adatum\Administrator** with the password **Pa55w.rd**.

7. On the taskbar, right-click  **Start**, ** **and then select  **Windows PowerShell**.

8. In Windows PowerShell, type the following three commands, pressing Enter after each command:

  ```
  Net Use F: \\LON-DC1\USMT
F:
F:\scanstate /i:migapp.xml /i:miguser.xml /genconfig:Config.xml
  ```

>  **Note:** The creation of the **Config.xml** file begins. Wait until the command finishes.

9. In Windows PowerShell, type ** notepad Config.xml**, and then press Enter.

10. To verify that the content of  **Shared Documents** will be migrated, under the **Documents** node, make sure that the **migrate** attribute for **Shared Documents** is set to **yes**. The line should be similar to the following:

  ```
  component displayname="Shared Documents" migrate="yes"
  ```

11. To exclude  **Shared Music** from the migration, under the **Documents** node, modify the **migrate** attribute for Shared Music to value **“no”**. The line should look as shown here:

  ```
  component displayname="Shared Music" migrate="no"
  ```

12. To exclude Windows Defender settings from the migration, select  **Edit**, select  **Find**, type  **defender**, select  **Find Next**, ** **and then modify the  **migrate** attribute for **Windows-Defender-AM-Sigs** to value **“no”**.

13. Repeat the previous step and modify the  **migrate** attribute from yes to **no** for following two components:


  - Windows-Defender-AM-Engine

  - Security-Malware-Windows-Defender


14. Close Notepad, ** **and then select  **Save**. ** **

15. In Windows PowerShell, type  **notepad folders.xml**, and then press Enter.  **Folders.xml** is a custom XML file that will be used to migrate a folder named **Projects** to the new computer.

16. Change the  **&lt;Foldername&gt;** string to **Projects**. Do not forget to replace the  **&lt;** and **&gt;** symbols. The entire line should look similar to the following:

  ```
  &lt;pattern type= "File"&gt;C:\Projects\* [*]&lt;/pattern&gt;
  ```

17. Close Notepad, and then select  **Save**. ** **

18. On the taskbar, select  **File Explorer**.

19. In File Explorer, in the navigation pane, expand  **This PC**, and then select  **Local Disk (C:)**. In the details pane, double-click  **Projects**, and then verify that files named  **Project1.txt** and **Project2.txt** are in the folder.

20. In File Explorer, right-click in the details pane, select  **New**, select  **Text Document**, type _ _your name, and then press Enter _._



#### Task 2: Capture the user state
  
1. On  **LON-CL2**, in File Explorer, right-click  **This PC**, ** **and then select  **Manage**.

2. In Computer Management, in the navigation pane, expand  **Local Users and Groups**, and then select  **Users**.

3. In the details pane, verify that user named  **LocalAdmin** is listed, and then close **Computer Management**.

4. In Windows PowerShell, verify that no content is on the  **\\LON-DC1\MigStore** shared folder, by typing the following command and then pressing Enter:

  ```
  Dir \\lon-dc1\MigStore
  ```

5. Capture the  **LON-CL2** user state by typing the following command and then pressing Enter:

  ```
  F:\Scanstate \\LON-DC1\MigStore /i:migapp.xml /i:miguser.xml /i:folders.xml /config:Config.xml /ue:*\* /ui:adatum\vera /o
  ```

6. Wait until ScanState finishes, and then verify that the user state is captured in the shared folder by typing the following command and then pressing Enter: 


```
Dir \\lon-dc1\MigStore -Recurse
```


>  **Result**: After completing this exercise, you should have created and customized XML files to use with the USMT.


## Exercise 2: Restore the user state on the destination computer
  
#### Task 1: Restore the user state
  
1. Sign in to  **LON-CL1** as **Adatum\Administrator** with the password **Pa55w.rd**.

2. On  **LON-CL1**, on the taskbar, select  **File Explorer**.

3. In File Explorer, in the navigation pane, expand  **Local Disk (C:)**, expand  **Users**, and then verify that there is no subfolder named  **Vera**.

4. In File Explorer, in the navigation pane, select  **Local Disk (C:)**, and then in the details pane, verify that there is no folder named  **Projects**.

5. On the taskbar, right-click  **Start**, ** **and then select  **Computer Management**.

6. In Computer Management, in the navigation pane, expand  **Local Users and Groups**, and then select  **Users**.

7. In the details pane, verify that no user named  **LocalAdmin** is listed, and then close Computer Management.

8. On the taskbar, right-click  **Start** and then select **Windows PowerShell**.

9. In Windows PowerShell, type the following command, and then press Enter:

  ```
  Net Use F: \\LON-DC1\USMT
  ```

10. In Windows PowerShell, type  **F:**, and then press Enter.

11. In Windows PowerShell, type the following command, press Enter, and then wait for LoadState to finish:

  ```
  F:\Loadstate \\LON-DC1\MigStore /i:migapp.xml /i:miguser.xml /i:folders.xml /c
  ```

12. On the taskbar, select  **File Explorer**.

13. In File Explorer, in the navigation pane, expand  **Local Disc (C:)**, expand ** Users**, ** **and then verify that the subfolder named  **Vera** now exists.

14. On the taskbar, right-click  **Start**, and then select  **Computer Management**.

15. In Computer Management, in the navigation pane, expand  **Local Users and Groups**, and then select  **Users**.

16. In the details pane, verify that a user named  **LocalAdmin** does not exist, because it was excluded from the migration.

17. On the taskbar, right-click  **Start**, select  **Shutdown or sign out**, and then select  **Sign out**.



#### Task 2: Verify migration of user settings
  
1. Sign in to  **LON-CL1** as **Adatum\Vera** with the password **Pa55w.rd**. 

2. Verify that Vera has a black desktop, file with your name on the desktop and the same customizations as on  **LON-CL2**:


  -  **This PC** and **Vera Pace** folders are on the desktop

  - Calculator and Weather apps are pinned to the taskbar

  - Store and Mail apps are not pinned to the taskbar


3. On the taskbar, select  **File Explorer**.

4. In File Explorer, in the navigation pane, expand  **This PC**, expand  **Local Disk (C:)**, select  **Projects**, and then in the details pane, verify that all files from  **LON-CL2** have migrated, including the file with your name.

5. In the navigation pane, expand  **Users**, expand  **Public**, select  **Public Documents**, and then in the details pane, verify that  **Vera’s Public Documents** appears.

6. In the navigation pane, select  **Public Music**, and in the details pane, verify that the folder is empty. This is because the folder content did not migrate.



#### Task 3: Prepare for the next module
  
 When you are finished with the lab, revert the  **LON-CL1** and ** LON-CL2** virtual machines to their initial state. **Do not revertLON-DC1!**: 

1. On the host computer, start  **Hyper-V Manager**.

2. In the  **Virtual Machines** list, right-click **20697-2C-LON-CL1**, and then select  **Revert**.

3. In the  **Revert Virtual Machine** dialog box, select **Revert**.

4. Repeat steps 2 and 3 for  **20697-2C-LON-CL2**.

>  **Note:** Do not revert **LON-DC1**!  **LON-DC1** is synchronizing on-premises AD DS with Azure AD. You can shut down LON-DC1.

>  **Result**: After performing this exercise, you will restore user state on destination computer.



©2016 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode "Creative Commons Attribution 3.0 License"), additional terms may apply.  All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant.  This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.

  